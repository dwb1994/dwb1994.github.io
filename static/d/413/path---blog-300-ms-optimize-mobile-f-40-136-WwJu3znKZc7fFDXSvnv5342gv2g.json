{"data":{"site":{"siteMetadata":{"title":"dwb-blog","author":"dwb"}},"markdownRemark":{"id":"8535bf48-9ac9-5a8f-afb6-05d4985c13d3","html":"<p>移动端的click事件存在300ms延迟，这是为“双击放大”的效果提供一个反应时间，即300ms内双击屏幕放大页面，两次点击间隔超过300ms时不放大页面。</p>\n<p>但是这种效果的体验不好，在不需要用户双击放大的时候，click事件会在300ms后执行，给用户一种反应迟钝的感觉，那么如何消除这300ms延迟的影响呢？</p>\n<h2>方案一</h2>\n<p>设置viewport的user-scalable：no，禁止用户手动缩放页面，则使用click事件不会产生延迟。</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>viewport<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>user-scalable=no<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>但是这样设置页面就无法缩放了，有时这个功能还是有必要存在的。</p>\n<h2>方案二</h2>\n<p>首先分析一下：HTML5中新增了移动端的触摸事件，我们可以用其中的touchstart、touchmove和touchend事件来模拟点击的过程，由于touch相关事件没有延迟，因此用来模拟click事件可以解决300ms延迟的问题。</p>\n<p>梳理一下实现思路：\n我们要模拟的click事件，是在这个DOM（或冒泡到这个DOM）上手指触摸开始，且手指未曾在屏幕上移动（某些浏览器允许移动一个非常小的位移值），且在这个dom上手指离开屏幕，且触摸和离开屏幕之间的间隔时间较短（某些浏览器不检测间隔时间，也会触发click）才能触发。</p>\n<p>事件的触发顺序是：touchstart早于touchend早于click。</p>\n<p>为了统一浏览器间差异：</p>\n<p>1.用touchmove检测手指移动的距离，超过设定的值则不触发click事件；</p>\n<p>2.如果touchstart与touchend间隔时间过长，则不触发click事件。</p>\n<p>理清思路后，开始具体实现：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">onTap</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    element <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelectorAll</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 获取元素</span>\n    <span class=\"token keyword\">var</span> initX<span class=\"token punctuation\">,</span> initY<span class=\"token punctuation\">,</span> movedX<span class=\"token punctuation\">,</span> movedY<span class=\"token punctuation\">,</span> distance<span class=\"token punctuation\">,</span> startTime<span class=\"token punctuation\">,</span> delay<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 监听touchstart事件</span>\n    element<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'touchstart'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        startTime <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 记录touchstart的时间戳</span>\n        distance <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 初始化手指移动距离</span>\n        initX <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>changedTouches<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>clientX<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 初始化touchstart时的X/Y坐标</span>\n        initY <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>changedTouches<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>clientY<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 监听touchmove事件</span>\n        element<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'touchmove'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            movedX <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>changedTouches<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>clientX<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 实时获取touchmove时的X/Y坐标</span>\n            movedY <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>changedTouches<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>clientY<span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">// 计算手指位移距离</span>\n            distance <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">sqrt</span><span class=\"token punctuation\">(</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">pow</span><span class=\"token punctuation\">(</span>movedX <span class=\"token operator\">-</span> initX<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">pow</span><span class=\"token punctuation\">(</span>movedY <span class=\"token operator\">-</span> initY<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 监听touchend事件</span>\n    element<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'touchend'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        delay <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> startTime<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 获取touchend和touchstart的时间间隔</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>delay<span class=\"token operator\">&lt;</span><span class=\"token number\">300</span> <span class=\"token operator\">&amp;&amp;</span> distance<span class=\"token operator\">&lt;</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 执行传入的回调函数</span>\n        <span class=\"token punctuation\">}</span>\n        distance <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 重置距离</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>进一步优化</h2>\n<p>这样实现了上述的效果，不过依然存在问题。</p>\n<p>问题1：“点击穿透”现象；</p>\n<p>问题2：点击时，被点击元素没有反馈。</p>\n<p>先来说问题1：“点击穿透”现象：</p>\n<p>在上述代码中，如果页面中两个元素相互重叠，上层元素点击消失或移出点击范围，且下层元素有监听点击事件时，上层的点击会触发下层的点击事件。</p>\n<p>这是因为click事件有300ms的延迟，在touchend的时候隐藏了上层元素，而延时300ms的click事件点击到了下层的元素，即为“点击穿透”。</p>\n<p>解决方案：</p>\n<p>为touchend事件阻止默认动作：e.preventDefault();点击时，被点击元素经历如下事件流：touchstart->touchend->click。touchend时阻止默认行为，可以阻止后面事件的触发。</p>\n<p>再来说问题2：</p>\n<p>“所有能够响应触屏操作的元素在触屏后都应该有一个视觉上的反馈。这也是为什么一个”web”应用总是显得不够”原生”的主要原因之一。” —— React Native官方文档，TouchableWithoutFeedback</p>\n<p>解决：为元素在被点击时添加一个class，这个class应该由用户以参数形式传入，用户可以使用这个class添加反馈的样式。</p>\n<h2>优化后的代码：</h2>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">onTap</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">,</span> touchClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    element <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelectorAll</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> initX<span class=\"token punctuation\">,</span> initY<span class=\"token punctuation\">,</span> movedX<span class=\"token punctuation\">,</span> movedY<span class=\"token punctuation\">,</span> distance<span class=\"token punctuation\">,</span> startTime<span class=\"token punctuation\">,</span> delay<span class=\"token punctuation\">;</span>\n    element<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'touchstart'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        startTime <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        distance <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        initX <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>changedTouches<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>clientX<span class=\"token punctuation\">;</span>\n        initY <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>changedTouches<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>clientY<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 如果touchClass参数存在则为点击的元素添加class</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>touchClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            element<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>touchClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">// 长按元素超过300ms不触发点击事件，移除touchClass</span>\n            <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                element<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>touchClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token number\">300</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        element<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'touchmove'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            movedX <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>changedTouches<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>clientX<span class=\"token punctuation\">;</span>\n            movedY <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>changedTouches<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>clientY<span class=\"token punctuation\">;</span>\n            distance <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">sqrt</span><span class=\"token punctuation\">(</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">pow</span><span class=\"token punctuation\">(</span>movedX <span class=\"token operator\">-</span> initX<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">pow</span><span class=\"token punctuation\">(</span>movedY <span class=\"token operator\">-</span> initY<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>touchClass <span class=\"token operator\">&amp;&amp;</span> distance <span class=\"token operator\">></span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                element<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>touchClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    element<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'touchend'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        e<span class=\"token punctuation\">.</span><span class=\"token function\">preventDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 阻止默认动作</span>\n        delay <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> startTime<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>delay <span class=\"token operator\">&lt;</span> <span class=\"token number\">300</span> <span class=\"token operator\">&amp;&amp;</span> distance <span class=\"token operator\">&lt;</span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// 点击事件发生后移除touchClass</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>touchClass<span class=\"token punctuation\">)</span> element<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>touchClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        distance <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"title":"移动端 300ms 延迟解决方案及其优化","date":"February 01, 2017"},"excerpt":"移动端的click事件存在300ms延迟，这是为“双击放大”的效果提供一个反应时间，即300ms内双击屏幕放大页面，两次点击间隔超过300ms时不放大页面。 但是这种效果的体验不好，在不需要用户双击放大的时候，click事件会在300ms后执行，给用户一种反应迟钝的感觉，那么如何消除这300ms延迟的影响呢？ 方案一 设置viewport的user-scalable：no，禁止用户手动缩放页面，则使用click事件不会产生延迟。 但是这样设置页面就无法缩放了，有时这个功能还是有必要存在的。 方案二 首先分析一下：HTML5中新增了移动端的触摸事件，我们可以用其中的touchstart…"}},"pageContext":{"slug":"/blog/300ms-optimize-mobile/","previous":{"fields":{"slug":"/blog/react-component/"},"frontmatter":{"title":"React 组件之间如何交流 (ES6)","type":"blog","photos":["/img/others/phone-499991_1920@sm.jpg"],"tags":["React"],"process":null}},"next":{"fields":{"slug":"/blog/sketch-design/"},"frontmatter":{"title":"使用 Sketch 制作 APP 视觉设计稿","type":"blog","photos":["/img/others/sketchLogo@sm.jpg"],"tags":["Sketch","Design","UI","Mobile","React-Native","团队协作"],"process":null}}}}