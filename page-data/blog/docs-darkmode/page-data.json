{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/docs-darkmode/","result":{"data":{"site":{"siteMetadata":{"title":"dwb-blog","author":"dwb"}},"markdownRemark":{"id":"3ca3ce55-96f7-59ae-a10b-f38d1163ca84","html":"<h2>零、前言</h2>\n<p>10月份我进行了一次暗黑模式的 code review</p>\n<p>11月份我进行了一场 Docs 暗黑模式的分享，在此我整理成一篇博客，记录一下</p>\n<p>本次分享带来的是 Docs 适配暗黑模式的来龙去脉、简要介绍开发方案、分享项目中踩过的坑、引起的思考，希望给大家带来帮助。此外工程上有一些改动，因此借此机会宣讲后续开发规范。</p>\n<h2>一、项目背景</h2>\n<p>随着 iOS 13 和 Android 10 正式发布，暗黑（深色）模式逐渐进入大家视野，各大 APP 纷纷进行适配。MacOS 为用户提供了“浅色”、“深色”两种模式进行切换，暗黑对于程序员来说很容易接受，常见的 IDE 默认主题一般都是深色背景。\n暗黑模式的好处：</p>\n<ol>\n<li>省电</li>\n<li>色盲色弱友好</li>\n<li>弱光环境使用友好</li>\n<li>长时间专注用眼，减少视觉疲劳</li>\n<li>提升品质感与沉浸感</li>\n</ol>\n<p><strong>效果预览：</strong>\n<img src=\"/img/darkmode/yulan.png\"></p>\n<h2>二、开发过程</h2>\n<h3>1、沟通并确定排期</h3>\n<p>回顾项目开发的过程：</p>\n<p>由于需求排期较长，在项目初期进行了细化的排期</p>\n<pre>\n9.29-10.12 色值排查与替换（使用脚本），整理用到的组件（包括 不规范的色值、单色/多色 icon、图片 ）\n10.13-10.18 组件样式改造（基于 antd 本地化分支）\n10.19-10.25 icon、图片整理与替换（可能延期2天）\n走查与测试：\n10.13，设计师开始色值走查\n10.25，设计师开始全局走查\n11.01，设计师走查延后两周\n11.8-11.17 共计8PD，前端 0.5 * 1 人力支持，设计走查 0.2 * 3 人力\n11.17-11.19 测试介入\n11.24 全量上线代码\n\n关键文档：组件梳理文档，分模块梳理各个页面用到的 单色 icon、多色 icon 和图片，三个部分\n</pre>\n<h3>2、进行工程改造</h3>\n<h4>1. 色值切换原理</h4>\n<p><strong>使用了 css variable 修改主题色</strong>，经调研符合目前系统的兼容性要求</p>\n<p>初始化时，在 js 逻辑中根据 isKim &#x26; 媒体查询，给 html 标签添加 className: .kim-dark-mode</p>\n<p>监听 media 的 change 事件，回调时修改 html 标签的 className</p>\n<div class=\"gatsby-highlight\" data-language=\"less\"><pre class=\"language-less\"><code class=\"language-less\"><span class=\"token comment\">// config/public/css-variables.ejs</span>\n<span class=\"token selector\">:root</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">--Gray01</span><span class=\"token punctuation\">:</span> #ffffff<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token selector\">:root.kim-dark-mode</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">--Gray01</span><span class=\"token punctuation\">:</span> #17181A<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// packages/ui/style/colors.less</span>\n<span class=\"token variable\">@Gray01<span class=\"token punctuation\">:</span></span> <span class=\"token function\">var</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span>Gray01<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// packages/ui/style/utils.less</span>\n<span class=\"token comment\">// 媒体查询 暗黑模式特殊判断逻辑</span>\n<span class=\"token comment\">// 传入代码片段, IMP: 注意外层不能嵌套选择器</span>\n<span class=\"token selector\">.darkRules(<span class=\"token variable\">@rules</span>)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token selector\">html.kim-dark-mode</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">@rules</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>没有使用 less 的 modifyVars 方法，modifyVars 方法基于 less 在浏览器中的编译，工程改造成本较高</p>\n<h3>2. 构建色值变量</h3>\n<p>使用 css variables 的形式定义变量</p>\n<p>基于 colors-src.ts 文件构建出三个文件（npm run buildColor）</p>\n<ol>\n<li>/config/public/css-variables.ejs —— css variables</li>\n<li>/packages/ui/style/colors.less —— less variables</li>\n<li>/packages/ui/style/colors.ts —— ts variables</li>\n</ol>\n<p>ts 使用方法如下（不推荐，可能存在副作用）：</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// packages/ui/style/colors.ts 源文件</span>\n<span class=\"token keyword\">import</span> themes <span class=\"token keyword\">from</span> <span class=\"token string\">'./color-src'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> isKimDark <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@is-docs-packages/components/common-utils/dark'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> mode <span class=\"token operator\">=</span> isKimDark <span class=\"token operator\">?</span> <span class=\"token string\">'dark'</span> <span class=\"token operator\">:</span> <span class=\"token string\">'light'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> themeColors <span class=\"token operator\">=</span> themes<span class=\"token punctuation\">[</span>mode<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Gray01 <span class=\"token operator\">=</span> themeColors<span class=\"token punctuation\">.</span>Gray01<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// xxx.tsx 使用侧</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> colors <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@is-docs-packages/ui/style/colors'</span><span class=\"token punctuation\">;</span>\ncolors<span class=\"token punctuation\">.</span>Gray01</code></pre></div>\n<h3>3. 组件改造：</h3>\n<ol>\n<li>\n<p>基于上述色值切换原理，使用色值收敛脚本替换颜色，自动实现 <strong>业务组件</strong> 暗黑模式切换</p>\n<p><strong>原理：编写 node 脚本，遍历项目各个目录中的文件，使用正则进行字符串替换</strong></p>\n<p><strong>css变量中，十六进制色值修改为 @Gray01 的形式；rgba 修改为 rgba(var(—Gray01RGB), 0.2); 的形式。目前 docs 项目都迁移成了变量与 fade 形式 (除知识库)，改色值比较容易</strong></p>\n</li>\n<li>\n<p>基于 ant design 本地化，修改变量文件，实现 <strong>ant design 组件</strong> 的暗黑模式切换</p>\n<img src=\"/img/darkmode/1.png\" width=\"80%\">\n<p>ant design 的色值未支持暗黑模式，为了实现暗黑模式，需要将 ant design 的色值变量<strong>全部</strong>替换为支持切换暗黑模式的色值</p>\n<p>Docs 项目使用了很多 ant design 的组件（首页居多），以前使用样式覆盖，修改不方便。本地化后的目录是组件库项目的 【packages/ui/docs-antd】目录，<strong>以后修改 ant design 组件的基础样式都在这个目录下修改</strong></p>\n<p>本地化后，适配暗黑模式更方便</p>\n<p>ant design 色彩系统使用了函数计算，根据某一个基准色值生成一条渐变色板，优势是 <strong>样式变量高度收敛</strong>，劣势是 <strong>定制性比较差</strong>，不够灵活，3.x后色板算法没再更新，计算得出的某些色值 <strong>无法达到足够适合阅读的对比度</strong> 。关于 <a href=\"http://dwbbb.com/blog/ant-design-palettes/\">ant design 色板生成算法</a> 的原理、现存问题，有兴趣的同学可以看我的博客</p>\n<p>我们 Docs 项目有比较强的定制性需求，因此色板使用的是设计师定义的色值，但需要设计师维护所有色值，更新色值相对麻烦一些</p>\n<p><img src=\"/img/darkmode/2.png\"></p>\n<div class=\"gatsby-highlight\" data-language=\"less\"><pre class=\"language-less\"><code class=\"language-less\"><span class=\"token variable\">@primary-1<span class=\"token punctuation\">:</span></span> <span class=\"token function\">color</span><span class=\"token punctuation\">(</span>~`<span class=\"token function\">colorPalette</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@{primary-color}'</span><span class=\"token punctuation\">,</span> 1<span class=\"token punctuation\">)</span> `<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// replace tint(@primary-color, 90%)</span>\n<span class=\"token variable\">@primary-2<span class=\"token punctuation\">:</span></span> <span class=\"token function\">color</span><span class=\"token punctuation\">(</span>~`<span class=\"token function\">colorPalette</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@{primary-color}'</span><span class=\"token punctuation\">,</span> 2<span class=\"token punctuation\">)</span> `<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// replace tint(@primary-color, 80%)</span>\n<span class=\"token variable\">@primary-3<span class=\"token punctuation\">:</span></span> <span class=\"token function\">color</span><span class=\"token punctuation\">(</span>~`<span class=\"token function\">colorPalette</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@{primary-color}'</span><span class=\"token punctuation\">,</span> 3<span class=\"token punctuation\">)</span> `<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// unused</span>\n<span class=\"token variable\">@primary-4<span class=\"token punctuation\">:</span></span> <span class=\"token function\">color</span><span class=\"token punctuation\">(</span>~`<span class=\"token function\">colorPalette</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@{primary-color}'</span><span class=\"token punctuation\">,</span> 4<span class=\"token punctuation\">)</span> `<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// unused</span>\n<span class=\"token variable\">@primary-5<span class=\"token punctuation\">:</span></span> <span class=\"token function\">color</span><span class=\"token punctuation\">(</span>~`<span class=\"token function\">colorPalette</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@{primary-color}'</span><span class=\"token punctuation\">,</span> 5<span class=\"token punctuation\">)</span> `<span class=\"token punctuation\">;</span>\n<span class=\"token variable\">@primary-6<span class=\"token punctuation\">:</span></span> <span class=\"token variable\">@primary-color</span><span class=\"token punctuation\">;</span> \n<span class=\"token variable\">@primary-7<span class=\"token punctuation\">:</span></span> <span class=\"token function\">color</span><span class=\"token punctuation\">(</span>~`<span class=\"token function\">colorPalette</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@{primary-color}'</span><span class=\"token punctuation\">,</span> 7<span class=\"token punctuation\">)</span> `<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// replace shade(@primary-color, 5%)</span>\n<span class=\"token variable\">@primary-8<span class=\"token punctuation\">:</span></span> <span class=\"token function\">color</span><span class=\"token punctuation\">(</span>~`<span class=\"token function\">colorPalette</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@{primary-color}'</span><span class=\"token punctuation\">,</span> 8<span class=\"token punctuation\">)</span> `<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// unused</span>\n<span class=\"token variable\">@primary-9<span class=\"token punctuation\">:</span></span> <span class=\"token function\">color</span><span class=\"token punctuation\">(</span>~`<span class=\"token function\">colorPalette</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@{primary-color}'</span><span class=\"token punctuation\">,</span> 9<span class=\"token punctuation\">)</span> `<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// unused</span>\n<span class=\"token variable\">@primary-10<span class=\"token punctuation\">:</span></span> <span class=\"token function\">color</span><span class=\"token punctuation\">(</span>~`<span class=\"token function\">colorPalette</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@{primary-color}'</span><span class=\"token punctuation\">,</span> 10<span class=\"token punctuation\">)</span> `<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// unused</span>\n<span class=\"token comment\">// 转换成</span>\n<span class=\"token variable\">@primary-1<span class=\"token punctuation\">:</span></span> <span class=\"token variable\">@Blue09</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">@primary-2<span class=\"token punctuation\">:</span></span> <span class=\"token variable\">@Blue08</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">@primary-3<span class=\"token punctuation\">:</span></span> <span class=\"token variable\">@Blue07</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">@primary-4<span class=\"token punctuation\">:</span></span> <span class=\"token variable\">@Blue06</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">@primary-5<span class=\"token punctuation\">:</span></span> <span class=\"token variable\">@Blue05</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">@primary-7<span class=\"token punctuation\">:</span></span> <span class=\"token variable\">@Blue04</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">@primary-8<span class=\"token punctuation\">:</span></span> <span class=\"token variable\">@Blue03</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">@primary-9<span class=\"token punctuation\">:</span></span> <span class=\"token variable\">@Blue02</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">@primary-10<span class=\"token punctuation\">:</span></span> <span class=\"token variable\">@Blue01</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>转换过程使用了 <a href=\"https://github.com/bgrins/TinyColor\">tinyColor</a> 第三方库的 readability 函数，该函数返回两种颜色之间的对比度，需要先确定该色值所属的色板，相对来说更加准确，我的策略是<strong>先替换再走查</strong></p>\n<img src=\"/img/darkmode/3.png\" width=\"80%\">\n<p>另一种方式：\n之前第一版收敛色值时策略是<strong>先走查再替换</strong>：使用的是 <strong><a href=\"https://gka.github.io/chroma.js/#chroma-deltae\">deltaE</a></strong> 来计算颜色的相似性，梳理了各工程用到的色值，和设计师给出的色板进行了对应，梳理页面如下：</p>\n<img src=\"/img/darkmode/4.png\" width=\"80%\">\n<p>设计师对梳理的结果进行微调，确定最终替换脚本的规则，附：</p>\n<p>在 js 中计算 deltaE: <a href=\"https://stackoverflow.com/questions/54738431/calculate-deltae94-in-javascript\">https://stackoverflow.com/questions/54738431/calculate-deltae94-in-javascript</a></p>\n<p>第三方库 chroma 也有实现这个功能: <a href=\"https://gka.github.io/chroma.js/#chroma-deltae\">https://gka.github.io/chroma.js/#chroma-deltae</a></p>\n<h3>4. 通过 context 实现 tsx 中树节点更新</h3>\n<p>更新的一般包括图片、tsx 中的色值</p>\n<p>组件库 <code class=\"language-text\">is-docs-components/packages/components/component-ctx.tsx</code> 文件提供了暗黑模式的 context 实例，包含 isDark: boolean; theme: 色值表 这两个变量，Docs 首页项目在 App.tsx 中使用该 context，并提供 Provider</p>\n<p><strong>其他工程没有提供 Provider，则取到的 isDark 为 false，即不会影响未接入暗黑模式的工程</strong></p>\n<h3>5. icon 适配</h3>\n<p>原理：</p>\n<p>iconfont.cn 项目中，暗黑模式的命名是在对应的浅色模式 icon 后面加 <strong>“_dark” 后缀</strong></p>\n<p>执行脚本【npm run buildIcon（scripts/dark-icons-build.js）】</p>\n<p>从 iconfont 平台下载后，读取下载的 iconfont 文件，根据每个 svg 标签的 key 值是否包含  <strong>“_dark”后缀</strong> 打包成两个 iconfont.js 文件，初始化时根据 isKim &#x26; media isDark 确定引入的是 font<em>xxx.js 或者 font</em>xxx_dark.js </p>\n<p>媒体查询监听暗黑模式 onchange 时，<strong>删除 html 中对应的 svg sprite 标签</strong>，拼接新 script 标签（iconfont.js 文件）并 <strong>append</strong> 到 dom 中：</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// 执行 dark-icons-build.js 时，给 svg 标签加上 xmlns:theme 自定义属性，以便通过选择器查找</span>\ndocument<span class=\"token punctuation\">.</span><span class=\"token function\">querySelectorAll</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">svg[xmlns\\\\:theme=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>isDark <span class=\"token operator\">?</span> <span class=\"token string\">'light'</span> <span class=\"token operator\">:</span> <span class=\"token string\">'dark'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">]</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> script <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'script'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nscript<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> isDark <span class=\"token operator\">?</span> <span class=\"token constant\">PC_ICON_URL_DARK</span> <span class=\"token operator\">:</span> <span class=\"token constant\">PC_ICON_URL</span><span class=\"token punctuation\">;</span>\ndocument<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>script<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Icon 的 key 值不变，但对应的 Symbols 中引用的 iconfont path 已经改变，从而实现切换 light/dark 模式的 icons</p>\n<p>封装 &#x3C;IconFont /> 组件，color 属性通过 props 的形式传入色值的 key 值，传入错误的 key 值在开发环境会报 warning</p>\n<p>推荐通过 className &#x26; less 写色值，而不是通过 color props 传入</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BasicActiveRectIcon</span></span>\n<span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>k-docs-icon-cebianshouqi<span class=\"token punctuation\">\"</span></span>\n<span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">flexShrink</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n<span class=\"token attr-name\">color</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>red<span class=\"token punctuation\">\"</span></span>\n<span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">IconFont</span></span>\n<span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">fontSize</span><span class=\"token operator\">:</span> <span class=\"token string\">'16px'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">color</span><span class=\"token operator\">:</span> colors<span class=\"token punctuation\">.</span>Gray09 <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n<span class=\"token attr-name\">color</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Gray09<span class=\"token punctuation\">\"</span></span>\n<span class=\"token punctuation\">/></span></span></code></pre></div>\n<h3>6. 图片</h3>\n<p>通用图片收敛到组件库的 packages/components/assets/dark[light] 目录</p>\n<p>两个目录: 根目录 &#x26; dark</p>\n<img src=\"/img/darkmode/5.png\" width=\"80%\">\n<p>根据 context 中的 isDark flag，使用相同/不同图片</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> nullImg <span class=\"token keyword\">from</span> <span class=\"token string\">'@src/assets/light/null.png'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> nullImgDark <span class=\"token keyword\">from</span> <span class=\"token string\">'@src/assets/dark/null.png'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> useThemeContext <span class=\"token keyword\">from</span> <span class=\"token string\">'@is-docs-packages/hooks/useThemeContext'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>isDark<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useThemeContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Empty</span></span> <span class=\"token attr-name\">image</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>isDark <span class=\"token operator\">?</span> nullImgDark <span class=\"token operator\">:</span> nullImg<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span></code></pre></div>\n</li>\n</ol>\n<h3>7. 测试与上线</h3>\n<ol>\n<li>\n<p>测试与走查方案：</p>\n<p>a. docs 测试环境配置灰度，由于 Kima 包尚未准备好，docs 首页走查时前期是在 web 端走查，注释了 isKim 判断是否在 kim 内的逻辑</p>\n<p>b. 测试打出暗黑模式专用的 Kima 包，docs 标签页使用的是 docs 测试环境</p>\n</li>\n<li>\n<p>灰度方案</p>\n<p>a.\tKim 端计划在12月发布灰度版本，灰度范围逐步扩大，Docs 与 Kim 保持灰度范围一致</p>\n<p>b.\t新增的需求使用色值变量，自动实现暗黑模式，需求测试/走查时应注意回归暗黑模式样式</p>\n</li>\n<li>\n<p>上线方案</p>\n<p>a.\t11.25 全量上线暗黑模式代码，目的是代码 <strong>尽早</strong> 合入master，增量的业务尽早适配暗黑模式的写法，否则新需求代码合进来都需要为适配暗黑模式做转换</p>\n<p>b.\t上线之后通过 <strong>分享</strong> 的形式对齐工程与规范的变动</p>\n<p>c.\t上线后灰度范围 <strong>与 Kim 保持一致</strong>，直到 kim 全量上线</p>\n</li>\n</ol>\n<h2>三、编码规范</h2>\n<p>内部文档：GUI 一致性 2.0，不便对外展示，列举出部分目录，大体能看到包含的内容：</p>\n<ol>\n<li>规范说明</li>\n<li>目录结构</li>\n<li>less 样式编写<br/>\na. less 文件中变量的使用方式不变<br/>\nb. 后续需求需替换 fade 写法，否则构建时报错<br/>\nc. 使用色值变量文件 (colors.less) 中的色值<br/>\nd. 使用场景色<br/>\ne. 摹客平台新增规范<br/>\nf. 使用 vscode 插件<br/>\ng. 暗黑模式特殊判断<br/>\nh. 其他样式规范<br/></li>\n<li>色板更新与使用</li>\n<li>iconfont 更新与使用</li>\n<li>图片使用</li>\n<li>\n<p>修改组件库样式<br/>\na. 修改 ant design 组件的默认样式<br/>\nb. 历史遗留：修改自定义 ant design 组件样式<br/>\nc. 组件库的正确使用姿势：<br/></p>\n<p>场景色如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token literal-property property\">PrimaryColor</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Blue03<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 主色 (@Blue03)</span>\n<span class=\"token literal-property property\">CardBg</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray01<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 卡片背景色</span>\n<span class=\"token literal-property property\">CardNestedBg</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray02<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 卡片内嵌套区域背景色</span>\n<span class=\"token comment\">// 主按钮 - primary</span>\n<span class=\"token literal-property property\">ButtonPrimaryBg</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Blue03<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 主按钮背景色</span>\n<span class=\"token literal-property property\">ButtonPrimaryText</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray01<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 主按钮文本色</span>\n<span class=\"token literal-property property\">ButtonPrimaryBgHover</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Blue04<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 背景色 - hover</span>\n<span class=\"token literal-property property\">ButtonPrimaryTextHover</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray01<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 文本色 - hover</span>\n<span class=\"token literal-property property\">ButtonPrimaryBgActive</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Blue02<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 背景色 - active</span>\n<span class=\"token literal-property property\">ButtonPrimaryTextActive</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray01<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 文本色 - active</span>\n<span class=\"token literal-property property\">ButtonPrimaryBgDisabled</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Blue05<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 背景色 - disabled</span>\n<span class=\"token literal-property property\">ButtonPrimaryTextDisabled</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray01<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 文本色 - disabled</span>\n<span class=\"token comment\">// 次级按钮 - secondary</span>\n<span class=\"token literal-property property\">ButtonSecondaryBg</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray01<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 次级按钮背景色</span>\n<span class=\"token literal-property property\">ButtonSecondaryText</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray11<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 次级按钮文本色</span>\n<span class=\"token literal-property property\">ButtonSecondaryBgHover</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray02<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 背景色 - hover</span>\n<span class=\"token literal-property property\">ButtonSecondaryTextHover</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray11<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 文本色 - hover</span>\n<span class=\"token literal-property property\">ButtonSecondaryBgActive</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray03<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 背景色 - active</span>\n<span class=\"token literal-property property\">ButtonSecondaryTextActive</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray11<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 文本色 - active</span>\n<span class=\"token literal-property property\">ButtonSecondaryBgDisabled</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray03<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 背景色 - disabled</span>\n<span class=\"token literal-property property\">ButtonSecondaryTextDisabled</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray09<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 文本色 - disabled</span>\n<span class=\"token comment\">// 幽灵按钮 - ghost</span>\n<span class=\"token literal-property property\">ButtonGhostBg</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray01<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 幽灵按钮背景色</span>\n<span class=\"token literal-property property\">ButtonGhostText</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Blue03<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 幽灵按钮文本色</span>\n<span class=\"token literal-property property\">ButtonGhostBgHover</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Blue09<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 背景色 - hover</span>\n<span class=\"token literal-property property\">ButtonGhostTextHover</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Blue03<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 文本色 - hover</span>\n<span class=\"token literal-property property\">ButtonGhostBgActive</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Blue08<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 背景色 - active</span>\n<span class=\"token literal-property property\">ButtonGhostTextActive</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Blue03<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 文本色 - active</span>\n<span class=\"token literal-property property\">ButtonGhostBgDisabled</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray03<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 背景色 - disabled</span>\n<span class=\"token literal-property property\">ButtonGhostTextDisabled</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray09<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 文本色 - disabled</span>\n\n<span class=\"token literal-property property\">ContainerBorder</span><span class=\"token operator\">:</span> <span class=\"token function\">rgbaString</span><span class=\"token punctuation\">(</span>colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray11<span class=\"token punctuation\">,</span> <span class=\"token number\">0.12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 容器 border</span>\n<span class=\"token literal-property property\">DividerColor</span><span class=\"token operator\">:</span> <span class=\"token function\">rgbaString</span><span class=\"token punctuation\">(</span>colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray11<span class=\"token punctuation\">,</span> <span class=\"token number\">0.08</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 全局分割线</span>\n<span class=\"token literal-property property\">SelectColor</span><span class=\"token operator\">:</span> <span class=\"token function\">rgbaString</span><span class=\"token punctuation\">(</span>colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>GrayBlue01<span class=\"token punctuation\">,</span> <span class=\"token number\">0.08</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// item select</span>\n<span class=\"token literal-property property\">HoverColor</span><span class=\"token operator\">:</span> <span class=\"token function\">rgbaString</span><span class=\"token punctuation\">(</span>colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>GrayBlue01<span class=\"token punctuation\">,</span> <span class=\"token number\">0.05</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// item hover</span>\n<span class=\"token literal-property property\">ModalMaskBg</span><span class=\"token operator\">:</span> <span class=\"token function\">rgbaString</span><span class=\"token punctuation\">(</span>colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray14<span class=\"token punctuation\">,</span> <span class=\"token number\">0.45</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// modal 半透明遮罩</span>\n<span class=\"token literal-property property\">CardBoxShadow</span><span class=\"token operator\">:</span> <span class=\"token function\">rgbaString</span><span class=\"token punctuation\">(</span>colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray11<span class=\"token punctuation\">,</span> <span class=\"token number\">0.04</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 卡片阴影</span>\n<span class=\"token literal-property property\">TooltipBg</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray11<span class=\"token punctuation\">,</span> <span class=\"token comment\">// tooltip 背景色</span>\n<span class=\"token literal-property property\">TooltipText</span><span class=\"token operator\">:</span> colorBase<span class=\"token punctuation\">.</span>light<span class=\"token punctuation\">.</span>Gray01 <span class=\"token comment\">// tooltip 文本色</span></code></pre></div>\n</li>\n</ol>\n<h2>四、思考</h2>\n<h3>1、排期困境</h3>\n<ol>\n<li>\n<p>中间插入需求</p>\n<p>a. toast 样式改版——中间插入消化</p>\n<p>b. 线上样式问题—— 样式迭代，量大，本期不改</p>\n</li>\n<li>\n<p>设计师要求增加排期（toast）</p>\n<p>a. 使用甘特图梳理排期；</p>\n<p>b. 拆解大任务为小任务，每个任务定具体的交付时间节点，到节点时或邻近节点时确认；</p>\n<p>c. 了解各方诉求，寻求合适的方案</p>\n</li>\n</ol>\n<h3>2、沟通的重要性</h3>\n<ol>\n<li>\n<p>与组内同学沟通</p>\n<p>a. 已建立的规范 —— 色值一致性</p>\n<p>b. 提高效率 —— less 插件\nc. ant design 本地化\nd. 移动端入侵\ne. 上线前与工程 owner 沟通，确定下周上线的需求，提前合并代码（危）</p>\n<p>f. 进行 code review 或 workshop ，聆听大家的建议</p>\n</li>\n<li>\n<p>与其他部门沟通</p>\n<p>a. 设计师高频沟通</p>\n<p>i. 开发、测试方案\nii. 摹客上面设计规范修改</p>\n<p>b. 测试、产品</p>\n<p>i. 11.16 开会确认当前进度与测试方案 暗黑模式进度</p>\n<p>ii. 提前与 qa 确认测试时间及排期</p>\n<p>c. Kim 端</p>\n<p>i. 暗黑模式配置的开关能力如何通知 Docs</p>\n<p>ii. Kim 端的方案与规范，统一认知与目标</p>\n<p>iii. 测试时打包</p>\n<p>iv. 沟通灰度与上线方案</p>\n</li>\n</ol>\n<h3>3、上线的坑</h3>\n<p>其他工程接入包含暗黑模式的组件库代码，需要调整代码</p>\n<ol>\n<li>主要是 fade 转换成 rgba，但是项目多（首页/知识库/文档/表格/h5 加上各自调试子模块，共10项目），每个项目都要构建 &#x26; 发测试灰度 &#x26; 走查 &#x26; 测试，比较麻烦</li>\n<li>taro 项目没接入 ejs ，使用了 ejs，可以优化成引入 less；taro 项目接入</li>\n<li>文档 “外部” 项目，webpack 版本落后，没引用 ejs，导致上线后丢失了 css variables 定义，已修复，后续统一使用 less 文件</li>\n<li>其他 “外部” 项目，也需要合入代码</li>\n<li>ppt 项目工程结构和其他项目不同，一开始没考虑到，延后接入</li>\n</ol>\n<h2>五、todo与讨论</h2>\n<ol>\n<li>组件库需要随着设计规范更新，后面组件样式优化需求做</li>\n<li>样式隔离，现在组件样式存在很多“负负得正”场景，（重点需求、重要组件针对性地优化）</li>\n<li>lint 工具</li>\n<li>img key 封装</li>\n<li>css-variables.ejs 挪到 package/ui/style/variables.less</li>\n</ol>","frontmatter":{"title":"暗黑模式 Code Review & 分享","date":"November 29, 2021","gallery":null},"excerpt":"零、前言 10月份我进行了一次暗黑模式的 code review 11月份我进行了一场 Docs 暗黑模式的分享，在此我整理成一篇博客，记录一下 本次分享带来的是 Docs 适配暗黑模式的来龙去脉、简要介绍开发方案、分享项目中踩过的坑、引起的思考，希望给大家带来帮助。此外工程上有一些改动，因此借此机会宣讲后续开发规范。 一、项目背景 随着 iOS 13 和 Android 10 正式发布，暗黑（深色）模式逐渐进入大家视野，各大 APP 纷纷进行适配。MacOS 为用户提供了“浅色”、“深色”两种模式进行切换，暗黑对于程序员来说很容易接受，常见的 IDE…"}},"pageContext":{"slug":"/blog/docs-darkmode/","previous":{"fields":{"slug":"/blog/mars-ui-convergence/"},"frontmatter":{"title":"记一次前端项目 UI 收敛实践","type":"blog","photos":["/img/mars/banner.jpg"],"tags":["JavaScript"],"process":null}},"next":{"fields":{"slug":"/hobby/hobby-rabit/"},"frontmatter":{"title":"油画 - 虞美人下的白兔少女","type":"hobby","photos":["/img/2023-02-05-hobby-rabit/logo2.jpg"],"tags":null,"process":null}}}},"staticQueryHashes":["3128451518"]}